<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Execute stored procedure w/parameters in Dapper -</title><meta name=robots content="index,follow,noarchive"><meta name=description content="I'm using Dapper (thanks Sam, great project.) a micro ORM with a DAL and by some reason I'm not able to execute stored procedures with input parameters.
In a example service I've the following code:
public void GetSomething(int somethingId) { IRepository<Something, SomethingEnum> repository = UnitOfWork.GetRepository<Something, SomethingEnum>(); var param = new DynamicParameters(); param.Add(&#34;@somethingId&#34;, dbType: DbType.Int32, value:somethingId, direction: ParameterDirection.Input); var result = repository.Exec<Something>(SomethingEnum.spMyStoredProcedure, param); ... }  When the execution of the stored procedure is triggered a SqlException is thrown stating that I need to provide the 'somethingId'"><meta name=author content="Aldo Pusey"><link rel="preload stylesheet" as=style href=https://assets.cdnweb.info/hugo/paper/css/app.css><link rel="preload stylesheet" as=style href=https://assets.cdnweb.info/hugo/paper/css/an-old-hope.min.css><script defer src=https://assets.cdnweb.info/hugo/paper/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=./theme.png><link rel=icon href=./favicon.ico><link rel=apple-touch-icon href=./apple-touch-icon.png><meta name=generator content="Hugo 0.98.0"><meta property="og:title" content="Execute stored procedure w/parameters in Dapper"><meta property="og:description" content="I'm using Dapper (thanks Sam, great project.) a micro ORM with a DAL and by some reason I'm not able to execute stored procedures with input parameters. In a example service I've the following code: When the execution of the stored procedure is triggered a SqlException is thrown stating that I need to provide the"><meta property="og:type" content="article"><meta property="og:url" content="/execute-stored-procedure-w-parameters-in-dapper.html"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-07-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-25T00:00:00+00:00"><meta itemprop=name content="Execute stored procedure w/parameters in Dapper"><meta itemprop=description content="I'm using Dapper (thanks Sam, great project.) a micro ORM with a DAL and by some reason I'm not able to execute stored procedures with input parameters. In a example service I've the following code: When the execution of the stored procedure is triggered a SqlException is thrown stating that I need to provide the"><meta itemprop=datePublished content="2024-07-25T00:00:00+00:00"><meta itemprop=dateModified content="2024-07-25T00:00:00+00:00"><meta itemprop=wordCount content="507"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Execute stored procedure w/parameters in Dapper"><meta name=twitter:description content="I'm using Dapper (thanks Sam, great project.) a micro ORM with a DAL and by some reason I'm not able to execute stored procedures with input parameters. In a example service I've the following code: When the execution of the stored procedure is triggered a SqlException is thrown stating that I need to provide the"></head><body class=not-ready data-menu=true><header class=header><p class=logo><a class=site-name href=./index.html>BlogNews</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList,btnDark=document.querySelector(".btn-dark"),sysDark=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark"),setDark=e=>{bodyClx[e?"add":"remove"]("dark"),localStorage.setItem("dark",e?"yes":"no")};setDark(darkVal?darkVal==="yes":sysDark.matches),requestAnimationFrame(()=>bodyClx.remove("not-ready")),btnDark.addEventListener("click",()=>setDark(!bodyClx.contains("dark"))),sysDark.addEventListener("change",e=>setDark(e.matches))</script><nav class=menu><a href=./sitemap.xml>Sitemap</a></nav></header><main class=main><article class=post-single><header class=post-title><p><time>Jul 25, 2024</time>
<span>Aldo Pusey</span></p><h1>Execute stored procedure w/parameters in Dapper</h1></header><section class=post-content><img src=https://cdn.statically.io/img/cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto><p>I'm using <a href=# rel="nofollow noreferrer">Dapper</a> (thanks <a href=# rel="nofollow noreferrer">Sam</a>, great project.) a micro ORM with a DAL and by some reason I'm not able to execute stored procedures with input parameters.</p><p>In a example service I've the following code:</p><pre class="lang-cs prettyprint-override"><code>public void GetSomething(int somethingId) { IRepository&lt;Something, SomethingEnum&gt; repository = UnitOfWork.GetRepository&lt;Something, SomethingEnum&gt;(); var param = new DynamicParameters(); param.Add("@somethingId", dbType: DbType.Int32, value:somethingId, direction: ParameterDirection.Input); var result = repository.Exec&lt;Something&gt;(SomethingEnum.spMyStoredProcedure, param); ... } </code></pre><p>When the execution of the stored procedure is triggered a SqlException is thrown stating that I need to provide the 'somethingId'</p><p>Procedure or function 'spMyStoredProcedure' expects parameter '@somethingId', which was not supplied.</p><p>My <a href=# rel="nofollow noreferrer">DAL</a> is similar based on this github project of Pencroff.</p><p>Am I missing something here?</p><p><strong>Update:</strong> I am actually passing the commandType via the SomethingEnum:</p><pre class="lang-cs prettyprint-override"><code>public class SomethingEnum : EnumBase&lt;SomethingEnum, string&gt; { public static readonly SomethingEnum spMyStoredProcedure = new SomethingEnum("spMyStoredProcedure", "[dbo].[spMyStoredProcedure]", CommandType.StoredProcedure); public SomethingEnum(string Name, string EnumValue, CommandType? cmdType): base(Name, EnumValue, cmdType) { } } </code></pre><span class=d-none itemprop=commentCount></span><h2 class=mb0 data-answercount=5>5 Answers</h2><p>You need to tell it the command type: make sure there's a <code>commandType: CommandType.StoredProcedure</code> in the dapper call. Otherwise, it is simply executing the <strong>text</strong> command:</p><pre><code>spMyStoredProcedure </code></pre><p>(with some unused parameters in the ambient context). This is legal TSQL, and attempts to call <code>spMyStoredProcedure</code> without passing parameters - the same as if you put <code>spMyStoredProcedure</code> into SSMS and press f5.</p><p>Also, if your parameters are fixed, I would actually suggest just using:</p><pre><code>var param = new { somethingId }; </code></pre><p>or even just inline it completely:</p><pre><code>var result = repository.Exec&lt;Something&gt;(SomethingEnum.spMyStoredProcedure, new { somethingId }, commandType: CommandType.StoredProcedure); </code></pre><p>(note: if your <code>Exec&lt;T></code> method only ever handles stored procedures, you could move the <code>commandType</code> internal to the method - or you could make it an optional parameter that defaults to <code>CommandType.StoredProcedure</code>)</p><span class=d-none itemprop=commentCount>6</span><pre><code>var queryParameters = new DynamicParameters(); queryParameters.Add("@parameter1", valueOfparameter1); queryParameters.Add("@parameter2", valueOfparameter2); await db.QueryAsync&lt;YourReturnType&gt;( "{NameOfStoredProcedure}", queryParameters, commandType: CommandType.StoredProcedure) </code></pre><span class=d-none itemprop=commentCount>1</span><p>Since this was the top result for me, but there were no answers that deal with ExecuteNonQuery with table valued parameters, here is the code for that:</p><pre><code>var queryParameters = new DynamicParameters(); queryParameters.Add("@Param0", datatable0.AsTableValuedParameter()); queryParameters.Add("@Param1", datatable1.AsTableValuedParameter()); var result = await ExecuteStoredProc("usp_InsertUpdateTest", queryParameters); private async Task&lt;Result&lt;int&gt;&gt; ExecuteStoredProc(string sqlStatement, DynamicParameters parameters) { try { using (SqlConnection conn = new SqlConnection(connectionString)) { await conn.OpenAsync(); var affectedRows = await conn.ExecuteAsync( sql: sqlStatement, param: parameters, commandType: CommandType.StoredProcedure); return Result.Ok(affectedRows); } } catch (Exception e) { //do logging return Result.Fail&lt;int&gt;(e.Message); } } </code></pre><span class=d-none itemprop=commentCount>2</span><p>You'll need to extend it to support outbound parameters and returning results, but it contains the portion for creating the Dapper dynamic parameters.</p><pre><code>internal static bool ExecuteProc(string sql, List&lt;SqlParameter&gt; paramList = null) { try { using (SqlConnection conn = new SqlConnection (GetConnectionString())) { DynamicParameters dp = new DynamicParameters(); if(paramList != null) foreach (SqlParameter sp in paramList) dp.Add(sp.ParameterName, sp.SqlValue, sp.DbType); conn.Open(); return conn.Execute(sql, dp, commandType: CommandType.StoredProcedure) &gt; 0; } } catch (Exception e) { //do logging return false; } </code></pre><p>}</p><span class=d-none itemprop=commentCount>2</span><p>This works for me. Note that the method doing this is async, hence the await and QueryAsync. Also notice that an anonymous type is created to facilitate the 'Id' parameter being sent.</p><pre><code>await dbConnection.QueryAsync&lt;Something&gt;("StoredProcedureNameGoesHere @Id", new { Id = id }); </code></pre><span class=d-none itemprop=commentCount></span><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmirpJawrLvVnqmfpJ%2Bse6S7zGiorp2jqbawutJoaWptaW2BdIOOnq%2Bem6Wpsm6%2F06ipnpxdpb%2Bwr8SdrKudXax6sa3RmqSerJWnwG61zWabmqigmr8%3D</p></section><nav class=post-nav><a class=prev href=./tina-turner-death-hoax-illness-and-health-update-has-she-cured-with-stroke-450506-html.html><span>←</span><span>Tina Turner Death Hoax: Illness And Health Update- Has She Cured With Stroke?</span></a>
<a class=next href=./pinning-fun-festive-cocktails.html><span>Pinning: Fun &amp;amp; Festive Cocktails</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2024 <a href=./></a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p></footer><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/banner.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>